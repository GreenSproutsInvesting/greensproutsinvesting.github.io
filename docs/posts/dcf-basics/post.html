<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Green Sprouts Investing">
<meta name="dcterms.date" content="2025-11-25">

<title>Understanding DCF Valuation: The Basics – Green Sprouts Investing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-b663525e4b92bb903b2199e2d401bf36.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-c12b7d9d430a1356dc99012a494a9142.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Green Sprouts Investing</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Understanding DCF Valuation: The Basics</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Green Sprouts Investing </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 25, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#what-is-dcf-valuation" id="toc-what-is-dcf-valuation" class="nav-link active" data-scroll-target="#what-is-dcf-valuation">What is DCF Valuation?</a></li>
  <li><a href="#free-cash-flow-estimation" id="toc-free-cash-flow-estimation" class="nav-link" data-scroll-target="#free-cash-flow-estimation">Free Cash Flow Estimation</a></li>
  <li><a href="#present-value-of-future-free-cash-flows" id="toc-present-value-of-future-free-cash-flows" class="nav-link" data-scroll-target="#present-value-of-future-free-cash-flows">Present Value of Future Free Cash Flows</a></li>
  <li><a href="#terminal-value" id="toc-terminal-value" class="nav-link" data-scroll-target="#terminal-value">Terminal Value</a></li>
  <li><a href="#implementation-in-python" id="toc-implementation-in-python" class="nav-link" data-scroll-target="#implementation-in-python">Implementation in Python</a></li>
  <li><a href="#applying-the-model-to-real-companies" id="toc-applying-the-model-to-real-companies" class="nav-link" data-scroll-target="#applying-the-model-to-real-companies">Applying the Model to Real Companies</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>When valuing quality companies like Coca-Cola or Procter &amp; Gamble, I often find that my DCF models return surprisingly conservative target prices, quite often well below current market prices. Is my valuation method flawed, or are these companies simply overvalued?</p>
<p>In this post, we’ll walk through the fundamentals of Discounted Cash Flow (DCF) valuation, including how to properly account for terminal value using the perpetuity growth method. We’ll implement the model step-by-step in Python and apply it to several real companies to see what the model returns.</p>
<p>This is the first in a series of posts exploring DCF valuation. In future posts, we’ll refine the model by incorporating share buybacks and conduct a historical analysis to identify when quality companies have actually traded at fair value.</p>
<section id="what-is-dcf-valuation" class="level2">
<h2 class="anchored" data-anchor-id="what-is-dcf-valuation">What is DCF Valuation?</h2>
<p>The basic idea behind the discounted cash flow model is that a company is as valuable as the cash it will generate over time. We could consider how much cash the company will generate indefinitely. However, no company lives forever, and forecasting becomes increasingly uncertain the further we look into the future. That’s why it is common to split this calculation into two components:</p>
<ol type="1">
<li><p><strong>Projected cash flows</strong>: Accumulate the expected future cash flows for a given number of years. It is common to take 10 years, but any other number is equally valid. Additionally, we should consider the stability and long-term perspective of the company, as well as how long we, as investors, plan to keep the company in our portfolio. Maybe a shorter period is suitable for certain companies, such as cyclicals.</p></li>
<li><p><strong>Terminal value</strong>: This represents the value of all cash flows the company will generate beyond our projection period. There are two main models here: perpetuity growth model, which captures the idea of holding the company forever, and exit multiple, which models closing the position at a certain valuation multiple.</p></li>
</ol>
<p>In addition to all this, we must consider the time value of money. Cash flows generated in the future must be discounted to present value. For example, if we will receive 100 USD next year, and we use a discount rate (the return we expect to get from our investments) of 10%, the present value of those 100 USD is <span class="math inline">\(100/(1+0.1) = 90.91\)</span>. The reasoning behind this is that if we had 90.91 USD now, we could obtain those 100 USD next year if invested in an asset that would produce 10% returns. The concept of time value is fundamental in investment and discounting is how this model implements it.</p>
</section>
<section id="free-cash-flow-estimation" class="level2">
<h2 class="anchored" data-anchor-id="free-cash-flow-estimation">Free Cash Flow Estimation</h2>
<p>The basic inputs for a DCF model are: - Free cash flow estimation for year 0 (current FCF) - Estimated growth rate - Discount rate</p>
<p>With these parameters we can estimate future cash flows and convert them to present cash flows via discounting.</p>
<p>Given FCF for year <span class="math inline">\(i\)</span> and the estimated growth rate <span class="math inline">\(r\)</span>, we can compute an estimated FCF for the year after as:</p>
<p><span class="math display">\[FCF_{i+1} = FCF_i \cdot (1 + r)\]</span></p>
<p>For any year <span class="math inline">\(n\)</span> into the future:</p>
<p><span class="math display">\[FCF_n = FCF_0 \cdot (1+r)^n\]</span></p>
</section>
<section id="present-value-of-future-free-cash-flows" class="level2">
<h2 class="anchored" data-anchor-id="present-value-of-future-free-cash-flows">Present Value of Future Free Cash Flows</h2>
<p>Now we have a way of computing any future free cash flow. However, money in the future is worth less today due to the time value of money. I think about it as the opportunity cost. If we had the cash today, we could invest it and earn returns. We use a discount rate to convert future cash flows to their present value.</p>
<p>The present value, <span class="math inline">\(PV\)</span>, of some future value <span class="math inline">\(FV\)</span> one year from now is obtained as:</p>
<p><span class="math display">\[PV = \frac{FV}{(1+d)}\]</span></p>
<p>Looking further into the future, for year <span class="math inline">\(n\)</span>:</p>
<p><span class="math display">\[PV = \frac{FV_n}{(1+d)^n}\]</span></p>
<p>Where <span class="math inline">\(d\)</span> is the discount rate, representing our required rate of return or opportunity cost.</p>
</section>
<section id="terminal-value" class="level2">
<h2 class="anchored" data-anchor-id="terminal-value">Terminal Value</h2>
<p>The second part of the DCF model is the terminal value. The DCF model makes several estimations for the first <span class="math inline">\(N\)</span> years. However, after that period any estimation for cash flows, growth or discount rate is very uncertain. In order to address this it is common to estimate a terminal value that represents the cash to be made after that point in time. There are two main methods to estimate this:</p>
<ol type="1">
<li><strong>Perpetuity growth method</strong>: Estimate cash flows after year <span class="math inline">\(N\)</span> in a conservative way and apply discounting.</li>
<li><strong>Exit multiple method</strong>: Estimate the future price of the company based on some multiple of its metrics (e.g.&nbsp;15x FCF) and treat it as if you would sell it.</li>
</ol>
<p>In this post we will focus on the perpetuity growth model, which is more suitable for high quality companies with durable competitive advantages.</p>
<section id="terminal-value-from-perpetuity-growth" class="level3">
<h3 class="anchored" data-anchor-id="terminal-value-from-perpetuity-growth">Terminal Value from Perpetuity Growth</h3>
<p>The perpetuity growth method estimates how much free cash flows the company will generate from year <span class="math inline">\(N\)</span> until the end of times. In order to conservatively model this we assume a moderate perpetual growth rate, <span class="math inline">\(g\)</span>, for example 2-3%. The calculations look very similar to the previous ones:</p>
<p><span class="math display">\[FCF_{N+2} = FCF_{N+1} \cdot (1+g)\]</span></p>
<p><span class="math display">\[FCF_{N+1+n} = FCF_{N+1} \cdot (1+g)^n\]</span></p>
<p>These are all future values. We must apply discounting to obtain the corresponding present value:</p>
<p><span class="math display">\[PV(FCF_{N+1+n}) = \frac{FCF_{N+1+n}}{(1+d)^n} = \frac{FCF_{N+1} \cdot (1+g)^n}{(1+d)^n}\]</span></p>
<p>Finally, the terminal value is then the aggregate of all future cash flows discounted to year <span class="math inline">\(N\)</span>:</p>
<p><span class="math display">\[TV = \frac{FCF_{N+1}}{(1+d)} + \frac{FCF_{N+1} \cdot (1+g)}{(1+d)^2} + ... = \sum_{n=1}^{\infty} \frac{FCF_{N+1} \cdot (1+g)^{n-1}}{(1+d)^{n}}\]</span></p>
<p>These calculations result in a geometric series.</p>
</section>
<section id="geometric-series-simplification" class="level3">
<h3 class="anchored" data-anchor-id="geometric-series-simplification">Geometric Series Simplification</h3>
<p>The equation above defines a geometric series. A geometric series is a summation in which each element is obtained by multiplying the previous element by a constant factor:</p>
<p><span class="math display">\[a + ar + ar^2 + ar^3+...=\sum_{n=0}^{\infty}ar^n\]</span></p>
<p>A fundamental property of geometric series is that the sum converges only if <span class="math inline">\(|r| &lt; 1\)</span> and it converges to a value <span class="math inline">\(S = \frac{a}{1-r}\)</span>.</p>
<p>Note that we can map our terminal value series to this geometric series with <span class="math inline">\(a=\frac{FCF_{N+1}}{1+d}\)</span> and <span class="math inline">\(r=\frac{1+g}{1+d}\)</span>. From this it is clear that this method of computing the terminal value is only valid if the discount rate is larger than the perpetual growth rate. This is rather obvious if you think about it. A company that grows at a rate larger than the discount rate would be worth infinite!</p>
<p>The result of the geometric series is then:</p>
<p><span class="math display">\[TV = \frac{a}{1-r} = \frac{\frac{FCF_{N+1}}{1+d}}{1-\frac{1+g}{1+d}}\]</span></p>
<p>The denominator can be simplified:</p>
<p><span class="math display">\[1-\frac{1+g}{1+d} = \frac{1+d-1-g}{1+d} = \frac{d-g}{1+d}\]</span></p>
<p>And the final terminal value results in:</p>
<p><span class="math display">\[TV = \frac{\frac{FCF_{N+1}}{1+d}}{\frac{d-g}{1+d}} = FCF_{N+1} \frac{1+d}{(1+d)(d-g)} = \frac{FCF_{N+1}}{d-g}\]</span></p>
</section>
</section>
<section id="implementation-in-python" class="level2">
<h2 class="anchored" data-anchor-id="implementation-in-python">Implementation in Python</h2>
<p>Now that we’ve established the mathematical foundation, let’s implement these formulas in Python. We’ll build up the model step-by-step, creating functions for each component.</p>
<p>First, let’s implement the basic building blocks - projecting future FCF and calculating present values:</p>
<div id="97e923f5" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_future_FCF(FCF_0, r, n):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate future free cash flow based on current FCF and growth rate.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">    FCF_0 : float</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Current free cash flow (year 0)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">    r : float</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Annual growth rate (e.g., 0.05 for 5%)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n : int</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of years into the future</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Estimated FCF for year n</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FCF_0 <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> r)<span class="op">**</span>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6a0b4a60" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> present_value(fv, d, n):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate present value of a future cash flow.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    fv : float</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Future value to be discounted</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">    d : float</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Discount rate (e.g., 0.10 for 10%)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n : int</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of years in the future</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Present value of the future cash flow</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fv <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> d)<span class="op">**</span>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="294128bc" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> terminal_value(FCF_0, d, g):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate terminal value using perpetuity growth method.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    FCF_0 : float</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Free cash flow at the start of terminal period (year N+1)</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    d : float</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Discount rate (e.g., 0.10 for 10%)</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    g : float</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Perpetual growth rate (e.g., 0.03 for 3%)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Terminal value as of year N</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Note:</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -----</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Requires d &gt; g for the formula to be valid</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> FCF_0 <span class="op">/</span> (d <span class="op">-</span> g)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="29666f13" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dcf_valuation(FCF_0: <span class="bu">float</span>, shares: <span class="bu">float</span>, r: <span class="bu">float</span>, d: <span class="bu">float</span>, g: <span class="bu">float</span>, N: <span class="bu">int</span> <span class="op">=</span> <span class="dv">10</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute DCF valuation per share using perpetuity growth method.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -----------</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    FCF_0 : float</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Current free cash flow</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    shares : float</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Current shares outstanding (in millions)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    r : float</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Growth rate for projection period (e.g., 0.05 for 5%)</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    d : float</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Discount rate (e.g., 0.10 for 10%)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    g : float</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Perpetual growth rate for terminal value (e.g., 0.03 for 3%)</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">    N : int, optional</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Projection period in years (default: 10)</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    --------</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Estimated fair value per share</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project and discount FCF for N years</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    pvs <span class="op">=</span> [present_value(estimate_future_FCF(FCF_0, r, i<span class="op">+</span><span class="dv">1</span>), d, i<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(N)]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    PV <span class="op">=</span> <span class="bu">sum</span>(pvs)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate and discount terminal value</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    TV <span class="op">=</span> present_value(terminal_value(estimate_future_FCF(FCF_0, r, N<span class="op">+</span><span class="dv">1</span>), d, g), d, N)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total value per share</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (PV <span class="op">+</span> TV) <span class="op">/</span> shares</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="applying-the-model-to-real-companies" class="level2">
<h2 class="anchored" data-anchor-id="applying-the-model-to-real-companies">Applying the Model to Real Companies</h2>
<p>Now that we have a working DCF model, let’s apply it to some real companies to see what valuations we get. We will analyze three different companies with varying characteristics:</p>
<ol type="1">
<li><strong>Coca-Cola (KO)</strong>: A classic quality company with strong brand moat and stable cash flows</li>
<li><strong>Mondelez (MDLZ)</strong>: Another consumer staples company in the food/snacks sector</li>
<li><strong>LyondellBasell (LYB)</strong>: A cyclical chemicals company to show how the model handles volatility</li>
</ol>
<p>For each company, we will use current financial data and make reasonable assumptions about growth rates and discount rates based on their business characteristics.</p>
<section id="coca-cola-ko" class="level3">
<h3 class="anchored" data-anchor-id="coca-cola-ko">Coca-Cola (KO)</h3>
<p><strong>Company Overview:</strong> Who doesn’t know Coca-Cola? Coca-cola is a global beverage leader with one of the strongest brand portfolios in the world.</p>
<p><strong>Financial Data:</strong></p>
<ul>
<li>Current FCF: 4,741 million</li>
<li>Shares Outstanding: 4,309 million</li>
<li>Current Stock Price: ~$73</li>
</ul>
<p><strong>Model Assumptions:</strong></p>
<ul>
<li>Growth Rate (r): 4% - Quite conservative growth reflecting mature market but international expansion opportunities</li>
<li>Discount Rate (d): 5% - Low rate reflecting stable cash flows and strong competitive moat. It is probably unrealistic to ask much higher returns from such a company</li>
<li>Perpetual Growth (g): 3% - Again quite conservative</li>
<li>Projection Period: 10 years - Standard projection range</li>
</ul>
<p><strong>Valuation Result:</strong> $62.43 per share</p>
<p><strong>Analysis:</strong> The model suggests KO is currently trading about 17% above its fair value at $73. However, not long ago the stock was trading around $58, which would have represented an undervaluation according to this model. This demonstrates that quality companies do occasionally trade at or below fair value, though they typically command a premium due to their stability and moat. It is also true that the obtained return is not extraordinary, but good enough to give stability to a portfolio.</p>
</section>
<section id="mondelez-international-mdlz" class="level3">
<h3 class="anchored" data-anchor-id="mondelez-international-mdlz">Mondelez International (MDLZ)</h3>
<p><strong>Company Overview:</strong> Mondelez is a global snacking powerhouse. It owns many iconic brands like Oreo or Toblerone. Again, great brand power but I would say not at the level of Coca-Cola.</p>
<p><strong>Financial Data:</strong></p>
<ul>
<li>Current FCF: 3,523 million</li>
<li>Shares Outstanding: 1,347 million</li>
<li>Current Stock Price: ~$60</li>
</ul>
<p><strong>Model Assumptions:</strong></p>
<ul>
<li>Growth Rate (r): 4.5% - Slightly higher than KO, reflecting growth in emerging markets and snacking trends</li>
<li>Discount Rate (d): 5.5% - Slightly higher than KO due to more competitive snacking category</li>
<li>Perpetual Growth (g): 3% - Standard conservative value</li>
<li>Projection Period: 10 years - Standard range</li>
</ul>
<p><strong>Valuation Result:</strong> $124.22 per share</p>
<p><strong>Analysis:</strong> Interestingly, the model suggests MDLZ is significantly undervalued at its current price of ~$60, trading at roughly half its estimated fair value. This large gap could indicate either that our assumptions are too optimistic, or that the market is undervaluing MDLZ’s cash generation potential. Recent developments in the health/medical domain, such as Ozempic, may affect future sales according to some analysts. However, the snacking category seems to have strong tailwinds, so growth could be even larger. We shall see how this valuation fares once we start adding complexity to the analysis methodology. Maybe the FCF estimation is too enthusiastic?</p>
</section>
<section id="lyondellbasell-industries-lyb" class="level3">
<h3 class="anchored" data-anchor-id="lyondellbasell-industries-lyb">LyondellBasell Industries (LYB)</h3>
<p><strong>Company Overview:</strong> LyondellBasell is one of the world’s largest plastics, chemicals, and refining companies. As a cyclical business, its cash flows can swing enormously.</p>
<p><strong>Financial Data:</strong></p>
<ul>
<li>Current FCF: 1,980 million</li>
<li>Shares Outstanding: 324 million</li>
<li>Current Stock Price: ~$44.80</li>
</ul>
<p><strong>Model Assumptions:</strong></p>
<ul>
<li>Growth Rate (r): 3% - Conservative, reflecting cyclical nature and mature industry</li>
<li>Discount Rate (d): 12% - Higher rate reflecting cyclicality, commodity price risk, and the higher returns expected from riskier investments</li>
<li>Perpetual Growth (g): 2% - Very conservative for cyclical business</li>
<li>Projection Period: 10 years - Standard range</li>
</ul>
<p><strong>Valuation Result:</strong> $66.91 per share</p>
<p><strong>Analysis:</strong> The model suggests LYB is moderately undervalued at $44.80, trading at about 67% of its estimated fair value. However, this analysis highlights important limitations. The perpetuity growth method may not be the most suitable one to compute the terminal value. Personally, I would not hold a cyclical company forever - I typically invest in them during the low part of the cycle and sell during peaks. For this investment strategy, the exit multiple method would be more appropriate for estimating terminal value, as it better reflects the reality of eventually selling the position rather than holding indefinitely.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>We’ve built a complete DCF valuation model from first principles, implementing the perpetuity growth method to estimate terminal value. Applying this model to three different companies revealed some interesting insights:</p>
<ul>
<li><strong>Quality companies like KO</strong> can occasionally trade near fair value, though they often command a premium for their stability</li>
<li><strong>MDLZ appears significantly undervalued</strong> by this model, suggesting either overly optimistic assumptions or genuine market undervaluation</li>
<li><strong>Cyclical companies like LYB</strong> present challenges for perpetuity-based models, as current FCF may not represent normalized earnings</li>
</ul>
<p>The model produces reasonable valuations when we use appropriate discount rates that reflect each company’s risk profile. However, we’ve identified a significant limitation: we haven’t accounted for share buybacks, which many quality companies use aggressively to return value to shareholders.</p>
<section id="whats-next" class="level3">
<h3 class="anchored" data-anchor-id="whats-next">What’s Next?</h3>
<p>In the next post, we’ll enhance this model by incorporating share buybacks. When companies reduce their share count over time, FCF per share grows faster than the overall FCF growth rate. This adjustment often brings valuations much closer to market prices for companies that consistently buy back shares.</p>
<p>Stay tuned for Part 2: Adding Share Buybacks to the DCF Model!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>